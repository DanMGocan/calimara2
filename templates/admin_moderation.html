{% extends "base.html" %}

{% block title %}Panou de Moderare - Calimara{% endblock %}
{% block description %}Panou de administrare pentru moderarea conținutului și gestionarea utilizatorilor{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0"><i class="bi bi-shield-check text-danger me-2"></i>Panou de Moderare</h1>
                    <p class="text-muted mb-0">Panou de Administrare pentru Moderarea Conținutului și Gestionarea Utilizatorilor</p>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-outline-info btn-sm" onclick="testAIModeration()">
                        <i class="bi bi-cpu me-1"></i>Test AI
                    </button>
                    <div class="badge bg-danger fs-6">
                        <i class="bi bi-person-badge me-1"></i>{{ current_user.email }}
                    </div>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <div class="display-6 text-warning mb-2" id="pendingCount">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <h6 class="card-title">În Așteptare</h6>
                            <p class="card-text text-muted mb-0">Comentarii și Postări</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <div class="display-6 text-danger mb-2" id="flaggedCount">
                                <i class="bi bi-flag"></i>
                            </div>
                            <h6 class="card-title">Conținut Marcat</h6>
                            <p class="card-text text-muted mb-0">Toxicitate Ridicată</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <div class="display-6 text-info mb-2" id="suspendedCount">
                                <i class="bi bi-person-x"></i>
                            </div>
                            <h6 class="card-title">Utilizatori Suspendați</h6>
                            <p class="card-text text-muted mb-0">Conturi Blocate</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <div class="display-6 text-success mb-2" id="todayActions">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <h6 class="card-title">Acțiuni Azi</h6>
                            <p class="card-text text-muted mb-0">Activitate de Moderare</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="moderationTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-pane" type="button" role="tab">
                        <i class="bi bi-list-check me-1"></i>Tot Conținutul
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="flagged-tab" data-bs-toggle="tab" data-bs-target="#flagged-pane" type="button" role="tab">
                        <i class="bi bi-flag me-1"></i>Marcat pentru Revizuire
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ai-queue-tab" data-bs-toggle="tab" data-bs-target="#ai-queue-pane" type="button" role="tab">
                        <i class="bi bi-robot me-1"></i>Coadă Revizuire AI
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ai-logs-tab" data-bs-toggle="tab" data-bs-target="#ai-logs-pane" type="button" role="tab">
                        <i class="bi bi-journal-text me-1"></i>Jurnale AI
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-pane" type="button" role="tab">
                        <i class="bi bi-people me-1"></i>Gestionare Utilizatori
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics-pane" type="button" role="tab">
                        <i class="bi bi-graph-up me-1"></i>Analiză
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="moderationTabContent">
                <!-- All Content Tab -->
                <div class="tab-pane fade show active" id="pending-pane" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Tot Conținutul cu Scoruri de Toxicitate</h5>
                                <div>
                                    <select class="form-select form-select-sm" id="contentTypeFilter">
                                        <option value="all">Tot Conținutul</option>
                                        <option value="comments">Doar Comentarii</option>
                                        <option value="posts">Doar Postări</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="pendingContent" class="moderation-queue">
                                <!-- Content will be loaded here via JavaScript -->
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Se încarcă conținutul...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Flagged Content Tab -->
                <div class="tab-pane fade" id="flagged-pane" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-flag me-2"></i>Conținut Marcat pentru Revizuire Manuală</h5>
                        </div>
                        <div class="card-body">
                            <div id="flaggedContent" class="moderation-queue">
                                <!-- Content will be loaded here via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Tab -->
                <div class="tab-pane fade" id="users-pane" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-people me-2"></i>User Management</h5>
                                <div class="input-group" style="width: 300px;">
                                    <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                                    <button class="btn btn-outline-secondary" type="button" id="searchUsers">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="usersList">
                                <!-- Users will be loaded here via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Review Queue Tab -->
                <div class="tab-pane fade" id="ai-queue-pane" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-robot me-2"></i>Coadă Revizuire AI - Conținut Marcat</h5>
                            <small class="text-muted">Conținut marcat de AI care necesită revizuire umană</small>
                        </div>
                        <div class="card-body">
                            <div id="aiQueue">
                                <!-- AI flagged content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Logs Tab -->
                <div class="tab-pane fade" id="ai-logs-pane" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Jurnale AI Moderare</h5>
                                    <small class="text-muted">Toate deciziile AI de moderare cu scoruri de toxicitate</small>
                                </div>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadAILogs('all')">Toate</button>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="loadAILogs('approved')">Aprobate</button>
                                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="loadAILogs('flagged')">Marcate</button>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="loadAILogs('rejected')">Respinse</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="aiLogs">
                                <!-- AI moderation logs will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Toxicity Trends</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="toxicityChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Moderation Actions</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="actionsChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Recent Moderation Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentActions">
                                        <!-- Recent actions will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Moderation Action Modal -->
<div class="modal fade" id="moderationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Moderare Conținut</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="contentPreview"></div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Acțiune</label>
                        <select class="form-select" id="moderationAction">
                            <option value="approve">Aprobă</option>
                            <option value="reject">Respinge</option>
                            <option value="delete">Șterge</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Motiv</label>
                        <input type="text" class="form-control" id="moderationReason" placeholder="Motiv opțional...">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulare</button>
                <button type="button" class="btn btn-primary" id="submitModeration">Execută Acțiunea</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadModerationStats();
    loadPendingContent();
    
    // Content type filter change
    const contentTypeFilter = document.getElementById('contentTypeFilter');
    if (contentTypeFilter) {
        contentTypeFilter.addEventListener('change', loadPendingContent);
    }
    
    // Tab switching
    const tabs = document.querySelectorAll('#moderationTabs button[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const target = e.target.getAttribute('data-bs-target');
            switch(target) {
                case '#pending-pane':
                    loadPendingContent();
                    break;
                case '#flagged-pane':
                    loadFlaggedContent();
                    break;
                case '#ai-queue-pane':
                    loadAIQueue();
                    break;
                case '#ai-logs-pane':
                    loadAILogs('all');
                    break;
                case '#users-pane':
                    loadUsers();
                    break;
                case '#analytics-pane':
                    loadAnalytics();
                    break;
            }
        });
    });
});

function loadModerationStats() {
    fetch('/api/admin/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('pendingCount').innerHTML = `<i class="bi bi-clock-history"></i> ${data.pending_count}`;
            document.getElementById('flaggedCount').innerHTML = `<i class="bi bi-flag"></i> ${data.flagged_count}`;
            document.getElementById('suspendedCount').innerHTML = `<i class="bi bi-person-x"></i> ${data.suspended_count}`;
            document.getElementById('todayActions').innerHTML = `<i class="bi bi-check-circle"></i> ${data.today_actions}`;
        })
        .catch(error => console.error('Error loading stats:', error));
}

function loadPendingContent() {
    const contentType = document.getElementById('contentTypeFilter')?.value || 'all';
    fetch(`/api/admin/content/pending?content_type=${contentType}`)
        .then(response => response.json())
        .then(data => {
            renderContentQueue(data.content, 'pendingContent');
        })
        .catch(error => console.error('Error loading pending content:', error));
}

function loadFlaggedContent() {
    fetch('/api/admin/content/flagged')
        .then(response => response.json())
        .then(data => {
            renderContentQueue(data.content, 'flaggedContent');
        })
        .catch(error => console.error('Error loading flagged content:', error));
}

function renderContentQueue(content, containerId) {
    const container = document.getElementById(containerId);
    if (!content || content.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-check-circle text-success display-1"></i>
                <h5 class="mt-3">All Clear!</h5>
                <p class="text-muted">No content needs review at the moment.</p>
            </div>
        `;
        return;
    }
    
    const html = content.map(item => {
        const toxicityColor = item.toxicity_score > 0.7 ? 'danger' : item.toxicity_score > 0.4 ? 'warning' : 'success';
        const statusColor = item.moderation_status === 'flagged' ? 'danger' : item.moderation_status === 'pending' ? 'warning' : 'info';
        
        return `
        <div class="card mb-3 ${item.toxicity_score > 0.7 ? 'border-danger' : item.toxicity_score > 0.4 ? 'border-warning' : ''}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-${item.type === 'post' ? 'primary' : 'secondary'}">${item.type.toUpperCase()}</span>
                    <span class="text-muted ms-2">by @${item.author}</span>
                    <span class="badge bg-${statusColor} ms-2">${item.moderation_status.toUpperCase()}</span>
                    ${item.toxicity_score !== null ? `<span class="badge bg-${toxicityColor} ms-2">AI Score: ${(item.toxicity_score * 100).toFixed(1)}%</span>` : ''}
                </div>
                <div class="btn-group">
                    <button class="btn btn-success btn-sm" onclick="moderateContent(${item.id}, '${item.type}', 'approve')" title="Approve Content">
                        <i class="bi bi-check"></i> Approve
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="moderateContent(${item.id}, '${item.type}', 'reject')" title="Reject Content">
                        <i class="bi bi-x"></i> Reject
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="moderateContent(${item.id}, '${item.type}', 'delete')" title="Delete Content">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="viewContent(${item.id}, '${item.type}')" title="View Full Content">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                ${item.title ? `<h6 class="card-title">${item.title}</h6>` : ''}
                <p class="card-text">${item.content.substring(0, 200)}${item.content.length > 200 ? '...' : ''}</p>
                ${item.moderation_reason ? `<div class="alert alert-light p-2 mt-2"><small><strong>AI Reason:</strong> ${item.moderation_reason}</small></div>` : ''}
                <small class="text-muted">
                    <i class="bi bi-clock"></i> ${new Date(item.created_at).toLocaleString()}
                </small>
            </div>
        </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function moderateContent(id, type, action) {
    const reason = prompt(`Enter reason for ${action} (optional):`);
    
    fetch(`/api/admin/moderate/${type}/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, reason })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Content ${action}ed successfully`, 'success');
            loadPendingContent();
            loadFlaggedContent();
            loadModerationStats();
        } else {
            showToast(data.message || 'Action failed', 'danger');
        }
    })
    .catch(error => {
        console.error('Error moderating content:', error);
        showToast('Error performing action', 'danger');
    });
}

function loadUsers() {
    fetch('/api/admin/users/search?q=')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('usersList');
            if (!data.users || data.users.length === 0) {
                container.innerHTML = '<p class="text-muted">No users found.</p>';
                return;
            }
            
            const html = data.users.slice(0, 20).map(user => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title mb-1">${user.username}</h6>
                                <small class="text-muted">${user.email}</small>
                                ${user.is_admin ? '<span class="badge bg-danger ms-2">Admin</span>' : ''}
                                ${user.is_moderator ? '<span class="badge bg-warning ms-2">Moderator</span>' : ''}
                                ${user.is_suspended ? '<span class="badge bg-secondary ms-2">Suspended</span>' : ''}
                            </div>
                            <div>
                                <small class="text-muted">Joined: ${new Date(user.created_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        })
        .catch(error => console.error('Error loading users:', error));
}

function loadAnalytics() {
    const container = document.getElementById('recentActions');
    container.innerHTML = `
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Analytics and charts will be implemented in a future version.
            <br><br>
            For now, you can see moderation statistics in the overview cards above.
        </div>
    `;
}

function viewContent(id, type) {
    // Simple content viewer - could be enhanced with a modal
    alert(`Viewing ${type} ID: ${id}. Full content viewer coming soon.`);
}

function loadAIQueue() {
    fetch('/api/admin/moderation/queue')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('aiQueue');
            if (!data.queue || data.queue.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success text-center">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>Nu există conținut marcat pentru revizuire!</strong>
                        <br><small>Toate postările și comentariile au fost procesate.</small>
                    </div>
                `;
                return;
            }

            const html = data.queue.map(item => {
                const content = item.content;
                const analysis = item.ai_analysis;
                
                return `
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning bg-opacity-10">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-warning text-dark">${item.content_type.toUpperCase()}</span>
                                <strong>${content.title || (content.post_title ? 'Comment on: ' + content.post_title : 'Comment')}</strong>
                            </div>
                            <div>
                                <span class="badge bg-danger">Toxicitate: ${(analysis.toxicity_score || 0).toFixed(2)}</span>
                                <button class="btn btn-success btn-sm me-1" onclick="reviewContent(${item.log_id}, 'approved')">
                                    <i class="bi bi-check"></i> Aprobă
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="reviewContent(${item.log_id}, 'rejected')">
                                    <i class="bi bi-x"></i> Respinge
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${content.content}</p>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>Autor:</strong> ${content.author}<br>
                                    <strong>Data:</strong> ${new Date(content.created_at).toLocaleString()}
                                </small>
                            </div>
                            <div class="col-md-6">
                                <div class="ai-scores">
                                    <small><strong>AI Analiză:</strong></small><br>
                                    <small>Toxicitate: ${(analysis.toxicity_score || 0).toFixed(2)}</small><br>
                                    <small>Hărțuire: ${(analysis.harassment_score || 0).toFixed(2)}</small><br>
                                    <small>Discurs de ură: ${(analysis.hate_speech_score || 0).toFixed(2)}</small><br>
                                    <small>Conținut explicit: ${(analysis.sexually_explicit_score || 0).toFixed(2)}</small><br>
                                    <small>Înjurături românești: ${(analysis.romanian_profanity_score || 0).toFixed(2)}</small>
                                </div>
                            </div>
                        </div>
                        ${analysis.reason ? `<div class="alert alert-warning p-2 mt-2"><small><strong>Motiv AI:</strong> ${analysis.reason}</small></div>` : ''}
                    </div>
                </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading AI queue:', error);
            document.getElementById('aiQueue').innerHTML = '<div class="alert alert-danger">Error loading AI review queue</div>';
        });
}

function loadAILogs(decision = 'all') {
    const url = decision === 'all' ? '/api/admin/moderation/logs' : `/api/admin/moderation/logs?decision=${decision}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('aiLogs');
            if (!data.logs || data.logs.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle me-2"></i>
                        Nu există jurnale pentru filtrul selectat.
                    </div>
                `;
                return;
            }

            const html = data.logs.map(log => {
                let badgeClass = 'secondary';
                let icon = 'question-circle';
                
                switch(log.ai_decision) {
                    case 'approved':
                        badgeClass = 'success';
                        icon = 'check-circle';
                        break;
                    case 'flagged':
                        badgeClass = 'warning';
                        icon = 'flag';
                        break;
                    case 'rejected':
                        badgeClass = 'danger';
                        icon = 'x-circle';
                        break;
                }

                return `
                <div class="card mb-2 border-${badgeClass} border-opacity-25">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-${badgeClass} me-2">
                                        <i class="bi bi-${icon}"></i> ${log.ai_decision.toUpperCase()}
                                    </span>
                                    <span class="badge bg-secondary me-2">${log.content_type.toUpperCase()}</span>
                                    <strong class="me-2">${log.content_title}</strong>
                                    ${log.human_decision ? `<span class="badge bg-info">Human: ${log.human_decision}</span>` : ''}
                                </div>
                                <p class="mb-1 text-muted small">${log.content_preview}</p>
                                <div class="row">
                                    <div class="col-md-8">
                                        <small class="text-muted">
                                            <strong>Autor:</strong> ${log.content_author} | 
                                            <strong>Data:</strong> ${new Date(log.created_at).toLocaleString()}
                                            ${log.moderator ? ` | <strong>Moderat de:</strong> ${log.moderator}` : ''}
                                        </small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <small class="text-muted">
                                            Toxicitate: <strong>${(log.toxicity_score || 0).toFixed(2)}</strong>
                                        </small>
                                    </div>
                                </div>
                                ${log.ai_reason ? `<div class="mt-1"><small class="text-info"><strong>AI:</strong> ${log.ai_reason}</small></div>` : ''}
                                ${log.human_reason ? `<div class="mt-1"><small class="text-primary"><strong>Human:</strong> ${log.human_reason}</small></div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading AI logs:', error);
            document.getElementById('aiLogs').innerHTML = '<div class="alert alert-danger">Error loading AI logs</div>';
        });
}

function reviewContent(logId, decision) {
    const reason = prompt(`Motiv pentru ${decision === 'approved' ? 'aprobare' : 'respingere'}:`);
    if (reason === null) return; // User cancelled
    
    fetch(`/api/admin/moderation/review/${logId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ decision, reason })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Conținut ${decision === 'approved' ? 'aprobat' : 'respins'} cu succes`, 'success');
            loadAIQueue(); // Refresh queue
            loadModerationStats(); // Refresh stats
        } else {
            showToast(data.message || 'Acțiunea a eșuat', 'danger');
        }
    })
    .catch(error => {
        console.error('Error reviewing content:', error);
        showToast('Eroare la procesarea acțiunii', 'danger');
    });
}

function testAIModeration() {
    const testButton = document.querySelector('button[onclick="testAIModeration()"]');
    testButton.disabled = true;
    testButton.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Testing...';
    
    fetch('/api/admin/test-ai-moderation')
        .then(response => response.json())
        .then(data => {
            if (data.ai_working) {
                showToast('AI Moderation is working! Check console for details.', 'success');
                console.log('AI Moderation Test Results:', data);
            } else {
                showToast(`AI Moderation failed: ${data.error}`, 'danger');
                console.error('AI Moderation Test Failed:', data);
            }
        })
        .catch(error => {
            console.error('Test failed:', error);
            showToast('Test request failed. Check if you have admin access.', 'danger');
        })
        .finally(() => {
            testButton.disabled = false;
            testButton.innerHTML = '<i class="bi bi-cpu me-1"></i>Test AI';
        });
}

function showToast(message, type) {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}