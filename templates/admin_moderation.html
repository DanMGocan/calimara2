{% extends "base.html" %}

{% block title %}Panou de Moderare - Calimara{% endblock %}
{% block description %}Panou de administrare pentru moderarea conținutului și gestionarea utilizatorilor{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0"><i class="bi bi-shield-check text-danger me-2"></i>Panou de Moderare</h1>
                    <p class="text-muted mb-0">Panou de Administrare pentru Moderarea Conținutului și Gestionarea Utilizatorilor</p>
                </div>
                <div class="badge bg-danger fs-6">
                    <i class="bi bi-person-badge me-1"></i>{{ current_user.email }}
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <div class="display-6 text-warning mb-2" id="pendingCount">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <h6 class="card-title">În Așteptare</h6>
                            <p class="card-text text-muted mb-0">Comentarii și Postări</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <div class="display-6 text-danger mb-2" id="flaggedCount">
                                <i class="bi bi-flag"></i>
                            </div>
                            <h6 class="card-title">Conținut Marcat</h6>
                            <p class="card-text text-muted mb-0">Toxicitate Ridicată</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <div class="display-6 text-info mb-2" id="suspendedCount">
                                <i class="bi bi-person-x"></i>
                            </div>
                            <h6 class="card-title">Utilizatori Suspendați</h6>
                            <p class="card-text text-muted mb-0">Conturi Blocate</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <div class="display-6 text-success mb-2" id="todayActions">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <h6 class="card-title">Acțiuni Azi</h6>
                            <p class="card-text text-muted mb-0">Activitate de Moderare</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="moderationTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-pane" type="button" role="tab">
                        <i class="bi bi-clock-history me-1"></i>În Așteptare
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="flagged-tab" data-bs-toggle="tab" data-bs-target="#flagged-pane" type="button" role="tab">
                        <i class="bi bi-flag me-1"></i>Conținut Marcat
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-pane" type="button" role="tab">
                        <i class="bi bi-people me-1"></i>Gestionare Utilizatori
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics-pane" type="button" role="tab">
                        <i class="bi bi-graph-up me-1"></i>Analiză
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-pane" type="button" role="tab">
                        <i class="bi bi-gear me-1"></i>Setări
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="moderationTabContent">
                <!-- Pending Review Tab -->
                <div class="tab-pane fade show active" id="pending-pane" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Content Pending Review</h5>
                                <div>
                                    <select class="form-select form-select-sm" id="contentTypeFilter">
                                        <option value="all">All Content</option>
                                        <option value="comments">Comments Only</option>
                                        <option value="posts">Posts Only</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="pendingContent" class="moderation-queue">
                                <!-- Content will be loaded here via JavaScript -->
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading pending content...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Flagged Content Tab -->
                <div class="tab-pane fade" id="flagged-pane" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-flag me-2"></i>Flagged Content (High Toxicity)</h5>
                        </div>
                        <div class="card-body">
                            <div id="flaggedContent" class="moderation-queue">
                                <!-- Content will be loaded here via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Tab -->
                <div class="tab-pane fade" id="users-pane" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-people me-2"></i>User Management</h5>
                                <div class="input-group" style="width: 300px;">
                                    <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                                    <button class="btn btn-outline-secondary" type="button" id="searchUsers">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="usersList">
                                <!-- Users will be loaded here via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Toxicity Trends</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="toxicityChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Moderation Actions</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="actionsChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Recent Moderation Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentActions">
                                        <!-- Recent actions will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings-pane" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Moderation Settings</h5>
                        </div>
                        <div class="card-body">
                            <form id="moderationSettings">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="autoApproveThreshold" class="form-label">Auto-Approve Threshold</label>
                                            <input type="range" class="form-range" id="autoApproveThreshold" min="0" max="1" step="0.1" value="0.3">
                                            <div class="form-text">Content below this toxicity level will be auto-approved</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="autoRejectThreshold" class="form-label">Auto-Reject Threshold</label>
                                            <input type="range" class="form-range" id="autoRejectThreshold" min="0" max="1" step="0.1" value="0.8">
                                            <div class="form-text">Content above this toxicity level will be auto-rejected</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="moderationEnabled" checked>
                                            <label class="form-check-label" for="moderationEnabled">
                                                Enable Automated Moderation
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                            <label class="form-check-label" for="emailNotifications">
                                                Email Notifications for Flagged Content
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary mt-3">
                                    <i class="bi bi-save me-1"></i>Save Settings
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Moderation Action Modal -->
<div class="modal fade" id="moderationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Moderare Conținut</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="contentPreview"></div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Acțiune</label>
                        <select class="form-select" id="moderationAction">
                            <option value="approve">Aprobă</option>
                            <option value="reject">Respinge</option>
                            <option value="delete">Șterge</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Motiv</label>
                        <input type="text" class="form-control" id="moderationReason" placeholder="Motiv opțional...">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulare</button>
                <button type="button" class="btn btn-primary" id="submitModeration">Execută Acțiunea</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadModerationStats();
    loadPendingContent();
    
    // Content type filter change
    const contentTypeFilter = document.getElementById('contentTypeFilter');
    if (contentTypeFilter) {
        contentTypeFilter.addEventListener('change', loadPendingContent);
    }
    
    // Tab switching
    const tabs = document.querySelectorAll('#moderationTabs button[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const target = e.target.getAttribute('data-bs-target');
            switch(target) {
                case '#pending-pane':
                    loadPendingContent();
                    break;
                case '#flagged-pane':
                    loadFlaggedContent();
                    break;
                case '#users-pane':
                    loadUsers();
                    break;
                case '#analytics-pane':
                    loadAnalytics();
                    break;
            }
        });
    });
});

function loadModerationStats() {
    fetch('/api/admin/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('pendingCount').innerHTML = `<i class="bi bi-clock-history"></i> ${data.pending_count}`;
            document.getElementById('flaggedCount').innerHTML = `<i class="bi bi-flag"></i> ${data.flagged_count}`;
            document.getElementById('suspendedCount').innerHTML = `<i class="bi bi-person-x"></i> ${data.suspended_count}`;
            document.getElementById('todayActions').innerHTML = `<i class="bi bi-check-circle"></i> ${data.today_actions}`;
        })
        .catch(error => console.error('Error loading stats:', error));
}

function loadPendingContent() {
    const contentType = document.getElementById('contentTypeFilter')?.value || 'all';
    fetch(`/api/admin/content/pending?content_type=${contentType}`)
        .then(response => response.json())
        .then(data => {
            renderContentQueue(data.content, 'pendingContent');
        })
        .catch(error => console.error('Error loading pending content:', error));
}

function loadFlaggedContent() {
    fetch('/api/admin/content/flagged')
        .then(response => response.json())
        .then(data => {
            renderContentQueue(data.content, 'flaggedContent');
        })
        .catch(error => console.error('Error loading flagged content:', error));
}

function renderContentQueue(content, containerId) {
    const container = document.getElementById(containerId);
    if (!content || content.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-check-circle text-success display-1"></i>
                <h5 class="mt-3">All Clear!</h5>
                <p class="text-muted">No content needs review at the moment.</p>
            </div>
        `;
        return;
    }
    
    const html = content.map(item => {
        const toxicityColor = item.toxicity_score > 0.7 ? 'danger' : item.toxicity_score > 0.4 ? 'warning' : 'success';
        const statusColor = item.moderation_status === 'flagged' ? 'danger' : item.moderation_status === 'pending' ? 'warning' : 'info';
        
        return `
        <div class="card mb-3 ${item.toxicity_score > 0.7 ? 'border-danger' : item.toxicity_score > 0.4 ? 'border-warning' : ''}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-${item.type === 'post' ? 'primary' : 'secondary'}">${item.type.toUpperCase()}</span>
                    <span class="text-muted ms-2">by @${item.author}</span>
                    <span class="badge bg-${statusColor} ms-2">${item.moderation_status.toUpperCase()}</span>
                    ${item.toxicity_score !== null ? `<span class="badge bg-${toxicityColor} ms-2">AI Score: ${(item.toxicity_score * 100).toFixed(1)}%</span>` : ''}
                </div>
                <div class="btn-group">
                    <button class="btn btn-success btn-sm" onclick="moderateContent(${item.id}, '${item.type}', 'approve')" title="Approve Content">
                        <i class="bi bi-check"></i> Approve
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="moderateContent(${item.id}, '${item.type}', 'reject')" title="Reject Content">
                        <i class="bi bi-x"></i> Reject
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="moderateContent(${item.id}, '${item.type}', 'delete')" title="Delete Content">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="viewContent(${item.id}, '${item.type}')" title="View Full Content">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                ${item.title ? `<h6 class="card-title">${item.title}</h6>` : ''}
                <p class="card-text">${item.content.substring(0, 200)}${item.content.length > 200 ? '...' : ''}</p>
                ${item.moderation_reason ? `<div class="alert alert-light p-2 mt-2"><small><strong>AI Reason:</strong> ${item.moderation_reason}</small></div>` : ''}
                <small class="text-muted">
                    <i class="bi bi-clock"></i> ${new Date(item.created_at).toLocaleString()}
                </small>
            </div>
        </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function moderateContent(id, type, action) {
    const reason = prompt(`Enter reason for ${action} (optional):`);
    
    fetch(`/api/admin/moderate/${type}/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, reason })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Content ${action}ed successfully`, 'success');
            loadPendingContent();
            loadFlaggedContent();
            loadModerationStats();
        } else {
            showToast(data.message || 'Action failed', 'danger');
        }
    })
    .catch(error => {
        console.error('Error moderating content:', error);
        showToast('Error performing action', 'danger');
    });
}

function loadUsers() {
    fetch('/api/admin/users/search?q=')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('usersList');
            if (!data.users || data.users.length === 0) {
                container.innerHTML = '<p class="text-muted">No users found.</p>';
                return;
            }
            
            const html = data.users.slice(0, 20).map(user => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title mb-1">${user.username}</h6>
                                <small class="text-muted">${user.email}</small>
                                ${user.is_admin ? '<span class="badge bg-danger ms-2">Admin</span>' : ''}
                                ${user.is_moderator ? '<span class="badge bg-warning ms-2">Moderator</span>' : ''}
                                ${user.is_suspended ? '<span class="badge bg-secondary ms-2">Suspended</span>' : ''}
                            </div>
                            <div>
                                <small class="text-muted">Joined: ${new Date(user.created_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        })
        .catch(error => console.error('Error loading users:', error));
}

function loadAnalytics() {
    const container = document.getElementById('recentActions');
    container.innerHTML = `
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Analytics and charts will be implemented in a future version.
            <br><br>
            For now, you can see moderation statistics in the overview cards above.
        </div>
    `;
}

function viewContent(id, type) {
    // Simple content viewer - could be enhanced with a modal
    alert(`Viewing ${type} ID: ${id}. Full content viewer coming soon.`);
}

function showToast(message, type) {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}